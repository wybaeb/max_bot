# Telegram/MAX bridge

Бот маршрутизирует сообщения между сетями по правилам из `config/routes.json`.

## Быстрый старт

1. Добавьте Telegram-бота админом в каналы-источники (TG).
2. Добавьте MAX-бота админом в каналы-назначения (MAX).
3. Заполните `.env`.
4. Запустите деплой:

```bash
./scripts/deploy.sh
```

Если `config/routes.json` еще нет, `deploy.sh` автоматически вызовет `./bridge.sh` и создаст маршруты вида:

- все обнаруженные TG source-каналы -> все обнаруженные MAX destination-каналы.

## Если каналы добавили позже

После добавления бота в новые каналы выполните:

```bash
./bridge.sh --force
./scripts/deploy.sh
```

`--force` пересобирает `config/routes.json`.

## Как работает `bridge.sh`

`bridge.sh` создает роутинг только если конфига нет (или с `--force`) и проверяет:

- в Telegram найдены каналы, где бот админ;
- в MAX найдены каналы, где бот админ.

Если в одной из сетей каналов нет, конфиг не создается и выводится понятная ошибка: сначала нужно добавить бота админом и повторить запуск.

Важно: Telegram Bot API не дает полного списка чатов бота. Для автообнаружения канал должен быть виден через updates (обычно достаточно, чтобы в канале был новый пост после добавления бота).

## Маршруты

Файл: `config/routes.json`

Поддерживается:

- source:
  - `telegram` (`chat_id` и/или `chat_username`)
  - `max` (`chat_id`)
- destination:
  - `max` (`chat_id` или `user_id`)
  - `telegram` (`chat_id`)

## Безопасность

- Репост идет только из источников, явно указанных в `config/routes.json`.
- Если кто-то добавит бота в сторонний канал, сообщения из него игнорируются.
- Автовыбор destination в MAX отключен: все назначения задаются только маршрутом.

## Медиа

- Telegram `media_group` (альбом) отправляется в MAX одним сообщением с несколькими вложениями.
- Для крупных файлов через публичный Telegram Bot API возможен `file is too big`.
- Для больших видео/аудио используйте self-hosted Bot API и задайте `TELEGRAM_API_BASE_URL`.
